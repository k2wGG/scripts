// ==UserScript==
// @name         GetUraniumÂ AutoBoostÂ v2Â (UIâ€‘edition, 2024â€‘05Â fix)
// @namespace    https://github.com/k2wGG
// @version      2.3
// @description  ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚Ñ€Ñ‘Ñ… Ğ±ÑƒÑÑ‚ĞµÑ€Ğ¾Ğ² + ÑˆĞµÑÑ‚ĞµÑ€Ñ‘Ğ½ĞºĞ°â€‘GUI + Â«Ğ¼ÑĞ³ĞºĞ¸Ğ¹Â» keepâ€‘alive
// @match        https://www.geturanium.io/*
// @run-at       document-idle
// @inject-into  page
// @grant        none
// ==/UserScript==

;(function () {
  'use strict';
  console.info('ğŸš€ AutoBoost v2.3 loaded');

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. PatchedÂ isTrusted (Ğ´Ğ»Ñ React) â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  if (!Event.prototype.__ab_isTrustedPatched) {
    [Event, MouseEvent].forEach(C =>
      Object.defineProperty(C.prototype, 'isTrusted', {
        get () { return true }, configurable: true
      })
    );
    Event.prototype.__ab_isTrustedPatched = true;
  }

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ / storage â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  const DEF = {
    enabled   : true,
    autoAC    : true,
    autoSM    : true,
    autoCB    : true,
    logEach   : 10,     // c
    keepAlive : true    // <-- Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ²Â UI
  };
  const LS_KEY = 'gu-autoboost';
  const cfg = load();
  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(cfg));

  function load() {
    try { return { ...DEF, ...JSON.parse(localStorage.getItem(LS_KEY)||'{}') } }
    catch { return { ...DEF } }
  }

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Â«ĞœÑĞ³ĞºĞ¸Ğ¹Â» keepâ€‘alive â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  const PING = '/favicon.ico';   // Ğ¾Ñ‚Ğ´Ğ°ÑÑ‚ 200 Ğ¸ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ÑÑ‚
  const rnd  = (min,max)=>Math.random()*(max-min)+min;

  setInterval(() => {
    if (!cfg.keepAlive) return;
    fetch(PING, { cache:'no-store', mode:'no-cors' }).catch(()=>{});
    /* Ğ»Ñ‘Ğ³ĞºĞ¾Ğµ Â«ÑˆĞµĞ²ĞµĞ»ĞµĞ½Ğ¸ĞµÂ» ĞºÑƒÑ€ÑĞ¾Ñ€Ğ°Â / Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ */
    document.dispatchEvent(new MouseEvent('mousemove', { bubbles:true }));
    document.dispatchEvent(new Event('visibilitychange'));
  }, rnd(45,70)*1e3);   // 45â€‘70â€¯Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑÑ‚ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑÂ Ñ‡Ñ‘Ñ‚ĞºĞ¸Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ÑƒÑÑ‚ĞµÑ€Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  const LABEL = {
    autoAC : 'auto collector',
    autoSM : 'shard multiplier',
    autoCB : 'conveyor booster'
  };
  const timers = {}, nextLog = {value:Date.now()};

  const buttons = () => [...document.querySelectorAll('button')];
  const findBtn = f => buttons().find(b => b.innerText.toLowerCase().startsWith(LABEL[f]));

  /** ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ñ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° ĞºÑƒĞ»Ğ´Ğ°ÑƒĞ½Ğ° */
  function getRestMs(btn){
    if (!btn || !btn.disabled) return 0;              // Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½
    /* ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Â«Activatingâ€¦Â»Â â€” Ğ¶Ğ´Ñ‘Ğ¼ 3â€¯Ñ, Ğ½Ğµ ÑĞ¿Ğ°Ğ¼Ğ¸Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€ */
    if (/activating/i.test(btn.innerText)) return 3_000;

    const m = /(\d+)\s*m.*?(\d+)\s*s/i.exec(btn.innerText);
    return m ? (60*+m[1] + +m[2])*1e3 : 600e3;        // Ğ¸Ğ½Ğ°Ñ‡Ğµ Â«NNÂ mÂ NNÂ sÂ» Ğ¸Ğ»Ğ¸ fallback 10â€¯Ğ¼Ğ¸Ğ½
  }

  const simulateClick = el =>
    ['mousedown','mouseup','click'].forEach(t =>
      el.dispatchEvent(new MouseEvent(t,{bubbles:true,cancelable:true,view:window}))
    );

  function schedule(flag){
    clearTimeout(timers[flag]);
    if (!cfg.enabled){ timers[flag]=setTimeout(()=>schedule(flag),3e3); return }

    const btn=findBtn(flag), rest=getRestMs(btn);

    /* ĞºÑƒĞ»Ğ´Ğ°ÑƒĞ½Ğ° Ğ½ĞµÑ‚ â†’ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ĞºĞ»Ğ¸Ğº */
    if (rest===0){
      if (cfg[flag] && btn && !btn.disabled){
        simulateClick(btn);
        log(`âš¡ click Â«${flag}Â»`);
      }
      timers[flag]=setTimeout(()=>schedule(flag),1e3);
      return;
    }

    log(`â³ ${flag}: ${Math.round(rest/1e3)}Â s left`);
    timers[flag]=setTimeout(()=>schedule(flag),rest+1e3);
  }
  const startAll = () => Object.keys(LABEL).forEach(schedule);

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ + Ğ¿ĞµÑ€ĞµÑ€ĞµĞ½Ğ´ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  const init = () => {
    if (!findBtn('autoAC')) { requestAnimationFrame(init); return }
    console.info('âœ… AutoBoost initialised');
    startAll(); ensureUI();
  };
  document.readyState==='complete'
    ? init()
    : window.addEventListener('load', init, {once:true});

  new MutationObserver(m=>{ if(m.some(x=>x.type==='childList')) startAll() })
      .observe(document.documentElement,{childList:true,subtree:true});

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  function log(str){
    if(!cfg.logEach) return;
    const now=Date.now();
    if(now>=nextLog.value){
      console.log(`[AutoBoost] ${str}`);
      nextLog.value = now + cfg.logEach*1e3;
    }
  }

  /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. ĞœĞ¸Ğ½Ğ¸â€‘GUI â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
  function ensureUI(){
    if (document.querySelector('.gu-gear')) return;

    const css = `
.gu-gear{position:fixed;top:12px;right:12px;width:36px;height:36px;
  background:#1b1b25dd;border-radius:50%;display:flex;align-items:center;
  justify-content:center;cursor:pointer;z-index:2147483647;
  color:#8cf;font-size:20px;user-select:none;transition:transform .3s}
.gu-gear:hover{transform:rotate(60deg)}
.gu-panel{position:fixed;top:56px;right:12px;width:240px;background:#1b1b25f2;
  padding:12px 14px;border-radius:8px;font:13px/1.4 sans-serif;
  color:#cee;box-shadow:0 4px 12px #000b;z-index:2147483647;
  backdrop-filter:blur(4px)}
.gu-panel hr{border-color:#444;margin:6px -14px}
.gu-panel input[type=number]{width:60px;margin-left:4px;background:#111;
  color:#fee;border:1px solid #555;border-radius:4px;padding:2px 4px}
.gu-panel label{display:block;margin:5px 0}
.gu-panel button{margin-top:6px;padding:2px 8px;background:#444;border:0;
  border-radius:4px;color:#eee;cursor:pointer}`;
    const html = `
<div class="gu-gear" title="AutoBoost settings">âš™ï¸</div>
<div class="gu-panel" style="display:none">
  <label><input type="checkbox" id="gu-enabled"> script enabled</label><hr>
  <label><input type="checkbox" id="gu-ac"> Autoâ€¯Collector</label>
  <label><input type="checkbox" id="gu-sm"> Shardâ€¯Multiplier</label>
  <label><input type="checkbox" id="gu-cb"> Conveyorâ€¯Booster</label><hr>
  keepâ€‘aliveÂ <input type="checkbox" id="gu-ka"><br>
  log eachÂ <input type="number" id="gu-log" min="0" step="1">Â s
  <button id="gu-reset">reset</button>
</div>`;

    document.head.insertAdjacentHTML('beforeend', `<style>${css}</style>`);
    document.body.insertAdjacentHTML('beforeend', html);

    const $ = s=>document.querySelector(s),
          gear = $('.gu-gear'),
          pnl  = $('.gu-panel');

    const sync = () => {
      $('#gu-enabled').checked = cfg.enabled;
      $('#gu-ka').checked      = cfg.keepAlive;
      $('#gu-ac').checked      = cfg.autoAC;
      $('#gu-sm').checked      = cfg.autoSM;
      $('#gu-cb').checked      = cfg.autoCB;
      $('#gu-log').value       = cfg.logEach;
    }; sync();

    /* ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ UI */
    $('#gu-enabled').onchange = e=>{cfg.enabled   = e.target.checked;save();startAll()};
    $('#gu-ka').onchange      = e=>{cfg.keepAlive = e.target.checked;save()};
    $('#gu-ac').onchange      = e=>{cfg.autoAC    = e.target.checked;save()};
    $('#gu-sm').onchange      = e=>{cfg.autoSM    = e.target.checked;save()};
    $('#gu-cb').onchange      = e=>{cfg.autoCB    = e.target.checked;save()};
    $('#gu-log').onchange     = e=>{cfg.logEach   = Math.max(0,~~e.target.value);save()};
    $('#gu-reset').onclick    = ()=>{Object.assign(cfg,DEF);save();sync();startAll();console.clear()};

    const toggle = () => pnl.style.display = pnl.style.display==='none' ? 'block' : 'none';
    gear.onclick = toggle;
    window.addEventListener('keydown',e=>{
      if(e.altKey && e.key.toLowerCase()==='g'){e.preventDefault();toggle()}
    });

    /* ĞµÑĞ»Ğ¸ React ÑĞ¾Ñ‚Ñ€Ñ‘Ñ‚ DOM, Ğ²ĞµÑ€Ğ½Ñ‘Ğ¼ UI Ğ½Ğ°Ğ·Ğ°Ğ´ */
    new MutationObserver(()=>setTimeout(ensureUI,0))
      .observe(document.body,{childList:true});
  }
})();
