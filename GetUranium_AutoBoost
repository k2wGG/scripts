// ==UserScript==
// @name         GetUraniumÂ AutoBoostÂ v2
// @namespace    https://github.com/k2wGG
// @version      2.0
// @description  ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ‚Ñ€Ñ‘Ñ… Ð±ÑƒÑÑ‚ÐµÑ€Ð¾Ð² ÑÂ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð¼
// @match        https://www.geturanium.io/*
// @run-at       document-end
// @grant        none
// ==/UserScript==

(function () {
  'use strict';
  console.log('ðŸš€ AutoBoost v4 loaded');

  /* 0.Â Â«Ð“Ð»ÑƒÑˆÐ¸Ð¼Â» Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒÂ isTrusted (React Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ syntheticâ€‘click)Â */
  [Event, MouseEvent].forEach(C =>
    Object.defineProperty(C.prototype, 'isTrusted', {
      get() { return true; },
      configurable: true
    })
  );

  /* 1.Â ÐšÐ°ÐºÐ¸Ðµ Ð±ÑƒÑÑ‚ÐµÑ€Ñ‹ Ð´ÐµÑ€Ð¶Ð¸Ð¼ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½Ð½Ñ‹Ð¼Ð¸Â */
  const CFG = { autoAC: true, autoSM: true, autoCB: true };

  /* 2.Â Ð§ÐµÐ»Ð¾Ð²ÐµÑ‡ÐµÑÐºÐ¸Ðµ ÑÑ€Ð»Ñ‹ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾ÐºÂ */
  const LABEL = {
    autoAC: 'auto collector',
    autoSM: 'shard multiplier',
    autoCB: 'conveyor booster'
  };

  /* 3.Â ÐŸÐ¾Ð¸ÑÐº Â«Ð¶Ð¸Ð²Ð¾Ð¹Â» ÐºÐ½Ð¾Ð¿ÐºÐ¸ */
  function findBtn(flag) {
    const label = LABEL[flag];
    return [...document.querySelectorAll('button')]
      .find(b => b.innerText.toLowerCase().startsWith(label));
  }

  /* 4.Â ÐŸÐ°Ñ€ÑÐ¸Ð¼ " 9 m 54 s remaining " â†’ Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´Ñ‹ */
  function getRestMs(btn) {
    if (!btn || !btn.disabled) return 0;               // ÐºÐ½Ð¾Ð¿ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°
    const m = /(\d+)\s*m.*?(\d+)\s*s/.exec(btn.innerText);
    if (m) return (Number(m[1]) * 60 + Number(m[2])) * 1000;
    return 600_000;                                   // fallbackÂ 10 Ð¼Ð¸Ð½
  }

  /* 5.Â Â«Ð§ÐµÑÑ‚Ð½Ñ‹Ð¹Â» ÐºÐ»Ð¸Ðº â€”Â mousedownÂ â†’Â mouseupÂ â†’Â clickÂ */
  function simulateClick(el) {
    ['mousedown', 'mouseup', 'click'].forEach(type =>
      el.dispatchEvent(new MouseEvent(type, { bubbles: true, cancelable: true, view: window })));
  }

  /* 6.Â ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð»Ð°Ð³Ð°Â */
  const timers = {};                                  // {flag: timeoutID}
  function schedule(flag) {
    clearTimeout(timers[flag]);
    const btn   = findBtn(flag);
    const rest  = getRestMs(btn);

    if (rest === 0) {                                 // Ð±ÑƒÑÑ‚ÐµÑ€ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½
      if (CFG[flag] && btn && !btn.disabled) {
        console.log(`âš¡ï¸Â [AutoBoost] clicking "${flag}"`);
        simulateClick(btn);
      }
      timers[flag] = setTimeout(() => schedule(flag), 1_000);  // Ð¿ÐµÑ€ÐµÑÑ‡Ñ‘Ñ‚ Ñ‡ÐµÑ€ÐµÐ·Â 1 Ñ
      return;
    }

    console.log(`â³Â [AutoBoost] ${flag}: ${Math.round(rest / 1000)} sÂ left`);
    timers[flag] = setTimeout(() => schedule(flag), rest + 1_000);
  }

  /* 7.Â Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ñ€ÐµÐ½Ð´ÐµÑ€Ð°Â */
  function init() {
    if (!findBtn('autoAC')) {                          // ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÐµÑ‰Ñ‘ Ð½ÐµÂ Ð´Ð¾Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ñ‹
      requestAnimationFrame(init);
      return;
    }
    console.log('âœ…Â AutoBoost initialised');
    Object.keys(CFG).forEach(schedule);
  }
  init();

  /* 8.Â ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼ Ð»ÑŽÐ±Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑ€Ð¸ÑÐ¾Ð²ÐºÐ¸ ÐºÐ½Ð¾Ð¿Ð¾ÐºÂ */
  const ob = new MutationObserver(muts => {
    if (!muts.some(m => m.type === 'childList')) return;
    Object.keys(CFG).forEach(flag => schedule(flag));
  });
  ob.observe(document.documentElement, { childList: true, subtree: true });

})();
